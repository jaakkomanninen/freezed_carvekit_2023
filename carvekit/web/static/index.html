<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        tumppink: '#e278a6',
                        tumplate: {
                            100: '#cffafe',
                            200: '#95eaef',
                            300: '#52c3ff',
                            400: '#35bdf9',
                            500: '#35bdf9',
                            600: '#00a0ff',
                            700: '#1c7cd3',
                            800: '#2454ce',
                            900: '#2647b1',
                        }
                    }
                }
            }
        }
        function loaditems() {
            localStorage.setItem("capturelist", JSON.stringify({ "capture_list": [] }));
            console.log(JSON.parse(localStorage.getItem("capturelist")));
            var myHeaders = new Headers();
            localStorage.setItem('authToken', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjc0OSwiaWF0IjoxNjgxODY1MzM3fQ.LU2sSNWz4jA0Kbzf-xR6uKLI0j6ADreZTgoQQiZscoo');
            var mytoken = localStorage.getItem('authToken') ?? 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1aWQiOjc0OSwiaWF0IjoxNjgxODY1MzM3fQ.LU2sSNWz4jA0Kbzf-xR6uKLI0j6ADreZTgoQQiZscoo'
            myHeaders.append("Authorization", `Bearer ${mytoken}`);
            myHeaders.append("Cookie", "XSRF-TOKEN=69037de74da7056731b2d70d05d607a86Qf4FL3Qiv8oDqyqCyy%2F%2ByE%2FcQwvKQGvJ6lngbIqmXEzipNZ4vscMwjLVJXXbVHk89jR47Z7amyREAARHk7K5%2BUWA9tBaOuCHJ6yRqzeA1sY8nex5ZQdJIBfM5Y3WYVv; adonis-session=f41c84d9b75400efcbfa33923b128887zzZi2tnw3DKSpJHTGRDoYDZJn3XxMirW4LW4B2oeG33ddExc96oR526Zup67o4oDmUHnLP04EWnB0OioMT4FN7EvmAfpmrev2f76nMQmAmHMSOAXIa%2F90SLfqU%2FECYGX; adonis-session-values=25772d766ed3610755463bf761bc04763iO8jXx7FllF7bhSAn7xD6x%2BwuoTyeF441OsfG0WS7oTGTI0XvU7jSr3GgqxfcIxZC0JoMLbX%2F%2BJGOBXQ%2BTa8p%2B9102XGLUXZ4f516xvEIU9sTPTse1fQbZT7PkYSQJ1NIQEYYIKykXzddMwqI8HszqQbinXqGi%2FaC3lR3XY0Jg%3D");

            var raw = "";

            var requestOptions = {
                method: 'GET',
                headers: myHeaders,
                redirect: 'follow'
            };

            fetch("https://api.tumplate.com/api/video-drafts/33231/files?title=image_1", requestOptions)
                .then(response => response.json())
                .then(result => { localStorage.setItem('files', JSON.stringify(result)) })
                .catch(error => console.log('error', error));

        }
    </script>
    <style>
        #camera-preview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #overlay-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.5;
            object-fit: cover;
            /* adjust opacity as needed */
        }

        #take-photo {
            margin-top: 10px;
        }

        #captured-photo {
            display: none;
        }
    </style>
</head>

<body onload="loaditems()" class="p-4">
    <div class="md:col-span-1">
        <h3 id="modeheader" class="text-lg font-bold pb-2 leading-6 text-gray-900">Tumplate Product Image Capture</h3>
        <p id="modeexplanation" class="mt-1 text-xs text-gray-500">Choose image overlay markers and position your photo.
        </p>
    </div>
    <div id='apiinput' class="hidden block mt-4">
        <label for="api" class="block text-sm font-medium text-gray-700">Input api key</label>
        <div class="mt-1">
            <input type="text" name="api" id="api"
                class="block w-full rounded-md border-gray-300 mb-2 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                value="Tumplate2020">
        </div>
        <button type=" button" onclick="hideandsave()"
            class="ml-3 inline-flex justify-center rounded-md border border-transparent bg-teal-500 py-2 mb-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-tumplate-500 focus:ring-offset-2">Hide
            and save</button>
    </div>
    <div class="bg-white px-4 py-5 sm:rounded-lg sm:p-6">
        <div class="col-span-6 sm:col-span-3 pb-4">
            <label for="camerapicker" class="block text-sm font-medium text-gray-700">Choose camera</label>
            <select id="camerapicker" name="camerapicker"
                class="mt-1 block w-full rounded-md border border-gray-300 bg-white py-2 px-3 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm">
                <option selected="true">Default camera</option>
            </select>
        </div>

    </div>
    <div id="camera_view" width="100vw" height="100vw" style="width:420px;height:420px;position:relative;"
        class="-ml-4 hidden">
        <video id="camera-preview"></video>
        <img id="overlay-image" src="img/generic.png">
        <canvas id="captured-photo"></canvas>
    </div>
    <button type="button" id="zoom" onclick="hideandsave()"
        class="ml-3 inline-flex justify-center rounded-md border border-transparent bg-teal-500 py-2 mt-2 mb-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-tumplate-500 focus:ring-offset-2">Start
        preview mode</button>
    </div>
    </div>
    <div
        class="ml-3 inline-flex justify-center rounded-md border border-transparent py-2 mt-2 mb-2 px-4 text-xs font-medium text-gray-400 shadow-sm">
        Tests.</div>
    </div>
    <div class="my-12 min-w-full">
        <p class="block text-xs font-medium text-gray-700">Name for this photo</p>
        <textarea type="text" id="filetitle"
            class="text-2xl w-full border-0 rounded-md mt-4 font-bold tracking-tight text-tumplate-600" value=""
            placeholder="Please create the file name from options below."></textarea>
    </div>
    <form id="nameform">
        <fieldset id="namegenerator" class="border rounded-md p-4 border-gray-200">
            <legend class="mr-4 text-lg text-gray-500">Input the file name before taking the photo:</legend>

            <div id="variablelist" class="divide-y divide-gray-200">
                <div class="col-span-6 sm:col-span-3 pb-4">
                    <label for="prodgrp" class="block text-sm font-medium text-gray-700">Choose product
                        group</label>
                    <select id="prodgrp" name="prodgrp"
                        class="mt-1 block w-full rounded-md border border-gray-300 bg-white py-2 px-3 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm">
                        <option selected="true" value="HOI">Choose from list</option>
                        <option value="candle_fm">Full moon in...</option>
                        <option value="candle_nm">New moon in...</option>
                        <option value="candle_magic">Magic Candles</option>
                        <option value="candle_solar">Solar Return Candles</option>
                        <option value="candle_merc">Retrograde Candles</option>
                        <option value="spray">Sprays</option>
                        <option value="incense">Incense</option>
                        <option value="bath">Bath products</option>
                        <option value="">No category</option>
                    </select>
                </div>
                <div class="col-span-6 sm:col-span-3 pb-4">
                    <label for="custom_pre" class="block text-sm font-medium text-gray-700">Choose custom
                        identifier</label>
                    <select id="custom_pre" name="custom_pre"
                        class="mt-1 block w-full rounded-md border border-gray-300 bg-white py-2 px-3 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm">
                        <option selected="true" value="">Just custom field:</option>
                        <option value="cap">Capricorn</option>
                        <option value="aqu">Aquarius</option>
                        <option value="pis">Pisces</option>
                        <option value="ari">Aries</option>
                        <option value="tau">Taurus</option>
                        <option value="gem">Gemini</option>
                        <option value="can">Cancer</option>
                        <option value="leo">Leo</option>
                        <option value="vir">Virgo</option>
                        <option value="lib">Libra</option>
                        <option value="sco">Scorpio</option>
                        <option value="sag">Sagittarius</option>
                    </select>
                </div>
                <div class="col-span-6 sm:col-span-3 pb-4">
                    <label for="imgtype" class="block text-sm font-medium text-gray-700">Choose Image type</label>
                    <select id="imgtype" name="imgtype"
                        class="mt-1 block w-full rounded-md border border-gray-300 bg-white py-2 px-3 shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 sm:text-sm">
                        <option selected="true" value="front">Main/front</option>
                        <option value="label">Label</option>
                        <option value="top">Top</option>
                        <option value="instructions">Instructions</option>
                        <option value="affirmation">Affirmation</option>
                    </select>
                </div>
                <div id='custtxt' class="block mt-4">
                    <label for="cust" class="block text-sm font-medium text-gray-700">Custom name input</label>
                    <div class="mt-1">
                        <input type="text" name="cust" id="cust"
                            class="block w-full p-4 rounded-md border-gray-300 mb-2 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                            placeholder="Input custom name here or leave blank">
                    </div>
                </div>
            </div>
        </fieldset>
    </form>





    <label for="cameraFileInput">
        <span
            class="w-full min-w-full justify-center rounded-md border border-transparent bg-teal-500 py-6 mb-8 px-24 text-sm font-medium text-white shadow-sm hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-tumplate-500 focus:ring-offset-2">Open
            camera</span>

        <!-- The hidden file `input` for opening the native camera -->
        <input id="cameraFileInput" type="file" accept="image/*" capture="environment" class="hidden block m-4" />
    </label>

    <!-- displays the picture uploaded from the native camera -->
    <img id="pictureFromCamera" />

    <div class="bg-white">
        <div class="my-12 min-w-full">
            <h2 class="text-lg mt-4 font-bold tracking-tight text-gray-900">Your generated files will be listed
                below.
            </h2>

            <a href="#" class="block hover:bg-gray-50">
                <div id="outputs" class="block">

                </div>
        </div>
        </a>
    </div>

    <p id="txt"></p>
    <p id="logger" class="text-xs"></p>

    <script>
        function processClick() {
            var myfile = document.getElementById('filetitle');
            if (myfile.value) { document.getElementById("cameraFileInput").click() }
            else {
                document.getElementById('namegenerator').classList.remove('border-grey-200');
                document.getElementById('namegenerator').classList.add('border-tumplate-600');
                alert("Don't forget to enter the productname");
                return true
            }
        }
        document.getElementById("cameraFileInput").addEventListener("change", function () {
            const capturedImage = new Image();
            console.log(this.files[0]);
            capturedImage.src = window.URL.createObjectURL(this.files[0]);
            capturedImage.onload = function () {
                // Create a canvas element to draw the image onto
                const canvas = document.createElement('canvas');
                canvas.width = capturedImage.width;
                canvas.height = capturedImage.height;
                const context = canvas.getContext('2d');
                context.drawImage(capturedImage, 0, 0, capturedImage.width, capturedImage.height);

                // Convert the canvas to a JPEG Blob and display it
                canvas.toBlob(function (jpegBlob) {
                    // Do something with the JPEG Blob, e.g. upload to server
                }, 'image/jpeg', 1);
            };
            var dataUrl = window.URL.createObjectURL(this.files[0]);
            var inputtime = new Date();
            var newEntry = { "captureName": document.getElementById('filetitle').value == "" ? inputtime.valueOf() : document.getElementById('filetitle').value, "renderStart": inputtime.valueOf(), "status": "pending", "downloadURL": null };
            capturelist.capture_list.push(newEntry);
            localStorage.setItem('capturelist', JSON.stringify(capturelist));
            sendFile(dataUrl, newEntry);
            var outputlist = document.getElementById('outputs');
            var captureDiv = document.createElement('div');
            captureDiv.setAttribute('class', "w-full block");
            captureDiv.id = String(newEntry.captureName);
            outputlist.appendChild(captureDiv);
            let div2 = document.createElement('div');
            div2.id = `${String(newEntry.captureName).replace(/[^a-zA-Z0-9 -]/gm, "")}_row`;
            div2.setAttribute('class', "relative flex justify-start rounded-lg border border-gray-300 bg-white px-6 py-5 shadow-sm focus-within:ring-2 focus-within:ring-indigo-500 focus-within:ring-offset-2 hover:border-gray-400")
            captureDiv.appendChild(div2);
            var entrytitle = document.createElement('div');
            entrytitle.id = `${String(newEntry.captureName).replace(/[^a-zA-Z0-9 -]/gm, "")}_title`;
            entrytitle.setAttribute('class', "text-md font-medium p-2 text-gray-900");
            entrytitle.innerHTML = `<p>${newEntry.captureName}</p>`;
            div2.appendChild(entrytitle);
            var entrystatus = document.createElement('div');
            entrystatus.id = `${String(newEntry.captureName).replace(/[^a-zA-Z0-9 -]/gm, "")}_status`;
            entrystatus.setAttribute('class', "text-sm font-medium p-2 text-gray-900");
            entrystatus.innerHTML = `<p class="text-xs">Status</p><p class="text-sm text-grey-300">${newEntry.status}</p>`;
            div2.appendChild(entrystatus);
            let div3 = document.createElement('div');
            div3.setAttribute('class', "flex-shrink-0")
            div2.appendChild(div3);

            var capt = document.createElement('img');
            capt.setAttribute('class', "h-20 w-20 object-cover rounded-md");
            capt.id = `${String(newEntry.captureName).replace(/[^a-zA-Z0-9 -]/gm, "")}_raw`;
            capt.style.display = "block";
            capt.setAttribute('src', dataUrl);
            div3.appendChild(capt);
            let div4 = document.createElement('div');
            div4.setAttribute('class', "min-w-0  flex-1")
            div2.appendChild(div4);

        }
        );


        function move(array, from, to) {
            if (to === from) return array;

            var target = array[from];
            var increment = to < from ? -1 : 1;

            for (var k = from; k != to; k += increment) {
                array[k] = array[k + increment];
            }
            array[to] = target;
            return array;
        }
        document.getElementById('nameform').addEventListener('change', (k) => { updateName(k) });
        document.getElementById('cust').addEventListener('input', (k) => { updateName(k) });
        const overlayArray = ['img/generic.png', 'img/short.png', 'img/tall.png', 'img/off.png'];
        function updateName(e) {
            console.log(e);
            var formEl = document.forms.nameform;
            var formData = new FormData(formEl);
            var overlayindx = document.getElementById('prodgrp').selectedIndex;

            var opts = [3, 2, 1, 2, 2, 0, 0, 0, 2, 3, 0, 0, 0, 0, 0, 0, 0];
            var curOverlay = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
            document.getElementById("overlay-image").src = overlayArray[curOverlay[document.getElementById('prodgrp').selectedIndex]];
            var tempname = [];
            for (const value of formData.values()) {
                if (value != "") {
                    tempname.push(value);
                }

            };
            if ((!document.getElementById('cust').value == "") && (!document.getElementById('prodgrp').value == "")) {
                move(tempname, 0, 1)
            };
            document.getElementById('filetitle').value = tempname.join("_");
        }

        var capturelist = { 'capture_list': [] };

        document.getElementById('api').value = localStorage.getItem('carveapi');
        const cameraPreview = document.getElementById('camera-preview');
        const overlayImage = document.getElementById('overlay-image');

        const capturedPhoto = document.getElementById('captured-photo');
        const ctx = capturedPhoto.getContext('2d');
        overlayImage.addEventListener('click', processClick);

        if (!navigator.mediaDevices?.enumerateDevices) {
            console.log("enumerateDevices() not supported.");
        } else {
            // List cameras and microphones.
            navigator.mediaDevices.enumerateDevices()
                .then((devices) => {

                    devices.forEach(device => {
                        if (device.kind === 'videoinput') {
                            const option = document.createElement('option');
                            option.value = device.deviceId;
                            option.text = device.label || `Camera ${selectElement.length + 1}`;
                            selectElement.add(option);
                        }
                    });

                })
                .catch((err) => {
                    console.error(`${err.name}: ${err.message}`);
                });
        };

        const selectElement = document.getElementById('camerapicker');
        const zoomPicker = document.getElementById('zoom');
        var constraints = {
            aspectRatio: 1,
            facingMode: "environment",
            width: { min: 640, ideal: 1536 },
            height: { min: 640, ideal: 2048 },
            resizeMode: "crop",
            advanced: [
                { width: 1536, height: 2048 },
                { aspectRatio: 1 },
                { zoom: 3 }
            ]
        };

        var constraints2 = {
            aspectRatio: 1,
            facingMode: "environment",
            width: { min: 640, ideal: 2048 },
            height: { min: 640, ideal: 1536 },
            resizeMode: "crop",
            advanced: [
                { width: 2048, height: 1536 },
                { aspectRatio: 1 },
                { zoom: 3 }
            ]
        };

        zoomPicker.addEventListener('click', event => {
            document.getElementById("camera_view").setAttribute('class', "-ml-4");

            constraints2.advanced.zoom = 3;
            navigator.mediaDevices.getUserMedia({ video: constraints2 })
                .then(stream => {
                    cameraPreview.srcObject = stream;
                    console.log(cameraPreview.srcObject);
                    cameraPreview.play();
                    console.log('zoom changed to ' + (Number(zoomPicker.selectedIndex) + 1))
                })
                .catch(error => {
                    console.error('Error accessing media stream:', error);
                });
        });

        selectElement.addEventListener('change', event => {
            constraints2.advanced.zoom = Number(zoomPicker.selectedIndex) + 1;
            const selectedDeviceId = event.target.value;
            constraints2.deviceId = selectedDeviceId;
            navigator.mediaDevices.getUserMedia({ video: constraints2 })
                .then(stream => {
                    cameraPreview.srcObject = stream;
                    console.log(cameraPreview.srcObject);
                    cameraPreview.play();
                })
                .catch(error => {
                    console.error('Error accessing media stream:', error);
                });
        });
        // getUserMedia() is used to access the camera


        function getCameraData() {
            document.getElementById('')
        }


        function processImage(kuva) {
            let canvas = document.createElement('canvas');
            let ctx = canvas.getContext('2d');

            console.log('processing image')
            console.log(kuva);
            console.log(kuva.width);
            console.log(kuva.height);
            canvas.width = kuva.height;
            canvas.height = kuva.width;
            // Rotate the image if it is wider than tall
            if (kuva.width <= kuva.height) {
                ctx.translate(canvas.width / 2, canvas.height / 2);
                ctx.rotate(Math.PI / 2);
                ctx.drawImage(kuva, -kuva.width / 2, -kuva.height / 2);
            } else {
                canvas.width = kuva.width;
                canvas.height = kuva.height;
                ctx.drawImage(kuva, 0, 0);
            }

            // Trim away excess transparent pixels
            let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let pixels = imageData.data;
            let width = imageData.width;
            let height = imageData.height;
            let x, y, i, found;

            // Trim transparent pixels from top
            found = false;
            for (y = 0; y < height; y++) {
                for (x = 0; x < width; x++) {
                    i = (y * width + x) * 4 + 3; // Alpha channel index
                    if (pixels[i] > 0) {
                        found = true;
                        break;
                    }
                }
                if (found) break;
            }
            let top = y;

            // Trim transparent pixels from bottom
            found = false;
            for (y = height - 1; y >= 0; y--) {
                for (x = 0; x < width; x++) {
                    i = (y * width + x) * 4 + 3; // Alpha channel index
                    if (pixels[i] > 0) {
                        found = true;
                        break;
                    }
                }
                if (found) break;
            }
            let bottom = y;

            // Trim transparent pixels from left
            found = false;
            for (x = 0; x < width; x++) {
                for (y = 0; y < height; y++) {
                    i = (y * width + x) * 4 + 3; // Alpha channel index
                    if (pixels[i] > 0) {
                        found = true;
                        break;
                    }
                }
                if (found) break;
            }
            let left = x;

            // Trim transparent pixels from right
            found = false;
            for (x = width - 1; x >= 0; x--) {
                for (y = 0; y < height; y++) {
                    i = (y * width + x) * 4 + 3; // Alpha channel index
                    if (pixels[i] > 0) {
                        found = true;
                        break;
                    }
                }
                if (found) break;
            }
            let right = x;

            // Crop image to non-transparent area
            let croppedWidth = right - left + 1;
            let croppedHeight = bottom - top + 1;
            let croppedCanvas = document.createElement('canvas');
            let croppedCtx = croppedCanvas.getContext('2d');
            croppedCanvas.width = croppedWidth;
            croppedCanvas.height = croppedHeight;
            croppedCtx.drawImage(canvas, left, top, croppedWidth, croppedHeight, 0, 0, croppedWidth, croppedHeight);

            let scaleFactor = 1;
            if (croppedCanvas.height > 2048) {
                scaleFactor = 2048 / croppedCanvas.height;
            }
            let scaledWidth = croppedCanvas.width * scaleFactor;
            let scaledHeight = croppedCanvas.height * scaleFactor;
            let scaledCanvas = document.createElement('canvas');
            let scaledCtx = scaledCanvas.getContext('2d');
            scaledCanvas.width = scaledWidth;
            scaledCanvas.height = scaledHeight;
            scaledCtx.drawImage(croppedCanvas, 0, 0, croppedCanvas.width, croppedCanvas.height, 0, 0, scaledWidth, scaledHeight);

            // Return the scaled image data
            return scaledCanvas.toDataURL('image/png', 1)
        };

        function sendFile(fileString, newEntry) {
            console.log(newEntry);
            var myEntry = newEntry;
            const myToken = localStorage.getItem('authToken');
            fetch(fileString)
                .then(res => res.blob())
                .then(blob => {
                    var outputFile = blob;

                    var myHeaders = new Headers();
                    myHeaders.append("Authorization", `Bearer ${myToken}`);
                    myHeaders.append("Cookie", "XSRF-TOKEN=882bb94fe0cc3dc7481724ff34e69a64vqs2Z91ok0nyMxPGO3Wj0IR7b5MZX1jGU7Wav7LcgE9Gjm7npYBOvCg%2BM1g6gwCT2vnStB459SsAIP2HfSl3Nz7eIvM7fVNfpDI%2F1avC%2FbHIs%2FUAUQT4Q6UYBoZ2oqvd; adonis-session=071e088dd85732dcf06748910e432e24KBkYY%2B%2BHq%2FIBEKg6CWdd9L%2ByHK7iUudV%2FCpjeUPBN0GYovGVlkHAoJutBeaKR6fvBYMO4v8OT3dWA06jbchnE%2FOVWvIKdF2rhQDf9DaoGPLj5EH3JSk9jYbK8x74ixJh; adonis-session-values=6eb308eb445e7453d25985e2681bc413sOW5IfckzyEW5dcStvGwdRFeyUjk6ng73z9c9SRzA1j%2FnWxe7VOuZtbLRimJ3xMEaMxVhByQDB2Xe0TyZbEkDz3q%2BLrsXA1WjCrqfXxRAF8HQAZ4ErRFKaD871Ccksf0SCz07MwS8XqrVX%2FE8IPQIyBV0XFFe0P5G3tYQyCr4%2BA%3D");

                    var formdata0 = new FormData();
                    formdata0.append("file", outputFile, myEntry.captureName + ".jpg");

                    var requestOptionsDup = {
                        method: 'POST',
                        headers: myHeaders,
                        redirect: 'follow'
                    };
                    var requestOptionsPostImage = {
                        method: 'POST',
                        headers: myHeaders,
                        body: formdata0,
                        redirect: 'follow'
                    };
                    var requestOptionsGetFileID = {
                        method: 'GET',
                        headers: myHeaders,
                        redirect: 'follow'
                    };

                    fetch(`https://api.tumplate.com/api/video-drafts/35017/duplicate`, requestOptionsDup)
                        .then(response => response.json())
                        .then(result => {
                            const { id } = result;
                            fetch(`https://api.tumplate.com/api/video-drafts/${id}?withFiles=1`, requestOptionsGetFileID)
                                .then(response2 => response2.json())
                                .then(result2 => {
                                    const draftFilesList = result2.draftFilesList;
                                    console.log('draftFilesList', draftFilesList);
                                    const myFile = draftFilesList[2];
                                    console.log('myFile', myFile);
                                    fetch(`https://api.tumplate.com/api/temp-files?draft_file_id=${(Number(myFile.id) + 1)}`, requestOptionsPostImage)
                                        .then(response3 => response3.json())
                                        .then(result3 => {
                                            const draftIDtoSend = result3.draft_id;
                                            console.log('draftIDtoSend', result3);
                                            var apikey = "";
                                            if (apikey == "") { apikey = "Tumplate2020"; };
                                            var thisStatus = document.getElementById(`${String(myEntry.captureName).replace(/[^a-zA-Z0-9 -]/gm, "")}_status`);
                                            var returnHere = document.getElementById(`${String(myEntry.captureName).replace(/[^a-zA-Z0-9 -]/gm, "")}_row`);
                                            if (localStorage.getItem('capturelist')) {
                                                capturelist = JSON.parse(localStorage.getItem('capturelist'));
                                            }
                                            var myHeaders = new Headers();
                                            myHeaders.append("X-API-Key", apikey);
                                            myHeaders.append("Authorization", `Bearer ${apikey}`);

                                            var formdata = new FormData();
                                            formdata.append("crop", true);
                                            formdata.append("image_name", String(myEntry.captureName));
                                            formdata.append("crop_margin", "5px");
                                            if (result3.previewUrl) {
                                                formdata.append("image_url", result3.previewUrl);
                                            }
                                            else { formdata.append("image_file", outputFile, `${String(myEntry.captureName).replace(/[^a-zA-Z0-9 -]/gm, "")}`) }
                                            formdata.append("draft_file_id", myFile.id)
                                            formdata.append("draft_id", myFile.draft_id)
                                            formdata.append("tumplate_auth_token", String(myToken));
                                            // formdata.append("image_file", outputFile, `${String(myEntry.captureName).replace(/[^a-zA-Z0-9 -]/gm, "")}`);

                                            var requestOptionsXX = {
                                                method: 'POST',
                                                headers: myHeaders,
                                                body: formdata,
                                                redirect: 'follow'
                                            };
                                            console.log('image_url', formdata.get('image_url'), 'form data vals', formdata.get('image_name'), formdata.get('draft_file_id'), formdata.get('tumplate_auth_token'));
                                            console.log('key started for: ', formdata.get('image_name'), formdata.get('image_url'));
                                            document.getElementById(`${String(myEntry.captureName).replace(/[^a-zA-Z0-9 -]/gm, "")}_status`).innerHTML = `<p class="text-xs">Status</p><p class="text-xs text-tumplate-600">Sent to AI engine</p><a href="${result3.previewUrl}" target="_blank"><p class="text-xs text-gray-600">Raw image saved</p></a>`;
                                            document.getElementById(`${String(myEntry.captureName).replace(/[^a-zA-Z0-9 -]/gm, "")}_status`).onclick = "logg('refresh function coming up')"
                                            const myUrl = 'https://tumplateaiapi-wubawcqtea-uc.a.run.app/';
                                            const baseUrl = window.location.href;
                                            console.log('requestOptionsXX', requestOptionsXX);
                                            fetch(`${baseUrl}api/removebg`, requestOptionsXX)
                                                .then(response => response.blob())
                                                .then(blob => {
                                                    if (blob.type == 'image/png') {
                                                        console.log('blob type is' + blob.type)
                                                        // create a new image element
                                                        const keyedimg = new Image();
                                                        keyedimg.onload = () => {
                                                            // call the processImage function with the image element
                                                            const processedData = processImage(keyedimg);
                                                            console.log(processedData);
                                                        };
                                                        // set the image source to the blob data
                                                        var objectUrl = URL.createObjectURL(blob);
                                                        keyedimg.src = objectUrl;


                                                        var forwardThis = blob;
                                                        var keyedForm = new FormData();
                                                        var tumpToken = localStorage.getItem('authToken');
                                                        var myHeaders2 = new Headers();
                                                        myEntry.downloadURL = objectUrl;
                                                        myEntry.status = 'ready';
                                                        let div3 = document.createElement('div');
                                                        div3.setAttribute('class', "flex-shrink-0")
                                                        document.getElementById(`${String(myEntry.captureName).replace(/[^a-zA-Z0-9 -]/gm, "")
                                                            }_row`).appendChild(div3);
                                                        // Create an <img> element and set its source to the object URL
                                                        var img = document.createElement('img');
                                                        img.setAttribute('class', "h-20 w-20 object-cover rounded-md");
                                                        img.src = objectUrl;

                                                        // Append the <img> element to the document
                                                        div3.appendChild(img);
                                                        document.getElementById(`${String(newEntry.captureName).replace(/[^a-zA-Z0-9 -]/gm, "")
                                                            }_raw`).remove();

                                                        // Create a link with the object URL and set its download attribute
                                                        var link = document.createElement('a');
                                                        link.href = objectUrl;
                                                        link.setAttribute('class', "ml-3 inline-flex justify-center rounded-md border border-transparent bg-teal-500 py-2 mb-2 px-4 text-xs font-medium text-white shadow-sm hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-tumplate-500 focus:ring-offset-2")
                                                        link.download = `${myEntry.captureName}.png`;
                                                        link.innerHTML = `Download`;
                                                        document.getElementById(`${String(myEntry.captureName).replace(/[^a-zA-Z0-9 -]/gm, "")
                                                            }_status`).innerHTML = ` < p class= "text-xs" > Status</p > <p class="text-xs text-green-400">Success (${new Date().toLocaleTimeString()})</p>`
                                                        // Append the link to the document
                                                        document.getElementById(`${String(newEntry.captureName).replace(/[^a-zA-Z0-9 -]/gm, "")
                                                            }_row`).appendChild(link);
                                                    } else {
                                                        document.getElementById(`${String(newEntry.captureName).replace(/[^a-zA-Z0-9 -]/gm, "")
                                                            }`).remove();
                                                        revealAPI()
                                                    };
                                                })

                                                .catch(error => console.log('error', error));
                                        })
                                })
                        })
                })
                .catch(error => { console.log('error', error); revealAPI(); });
        };

        function revealAPI() {
            document.getElementById('apiinput').setAttribute('class', 'block');
            document.getElementById('api').value = localStorage.getItem('carveapi');
        }

        function hideandsave() {
            localStorage.setItem('carveapi', document.getElementById('api').value);
            console.log(localStorage.getItem('carveapi'));
            document.getElementById('apiinput').setAttribute('class', 'hidden');

        };


        const serverAddress = "https://api.tumplate.com";
        async function getTumplateTokenDynamic(userData) {
            var requestOptions = {
                "method": 'POST',
                "headers": { 'Content-Type': 'application/json' },
                "body": JSON.stringify(userData),
                "redirect": 'follow'
            };
            await fetch(serverAddress + "/api/auth/login", requestOptions)
                .then((response) => response.json())
                .then((dataa) => {
                    console.log(dataa)

                    localStorage.setItem('bulkToken', JSON.stringify(dataa));
                    console.log('superadmin found:' + dataa.user.first_name);

                    console.log('test account login: ' + dataa.user.username);
                    localStorage.setItem('baseToken', JSON.stringify(dataa));

                    return dataa
                });
        };


        function logg(mystring = 'text') {
            if (typeof mystring == 'object') {
                mystring = JSON.stringify(mystring);
            };
            var d = new Date();
            var n = d.toLocaleTimeString();
            var mylog = document.getElementById('logger');
            let temp = mylog.innerHTML;
            mylog.innerHTML = "(" + n + ") " + mystring + '\r' + temp;
        }


    </script>
</body>